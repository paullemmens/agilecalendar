---
title: Agile Cadence Calendar
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    dev: svg
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.asp = 0.618)
require(tidyverse)
require(flexdashboard)
require(ggrepel)
devtools::load_all()
```

Sidebar {.sidebar data-width=300}
=====================================

### Plot setup

```{r marker check boxes}
checkboxInput('cadence_markers', 'Plot cadence markers', value = TRUE)
checkboxInput('personal_markers', 'Plot personal markers', value = TRUE)
checkboxInput('today', 'Plot today marker', value = TRUE)
```


Viewer
========

```{r load configuration}
cfg_file <- pkgload::package_file('inst', 'default_config.yml')
cfg <- reactive({
  req(cfg_file)
  read_config(cfg_file)
})
acc <- reactive({
  generate_calendar(cfg = cfg())
})
```

Viewer {.tabset}
----------------

### Visual

```{r visual-calendar}
renderPlot({
  req(acc())
  p <- plot_calendar(cal = acc())
  if (input$cadence_markers) p <- p + plot_markers(cal = acc(), markers = 'agile_events')
  if (input$personal_markers) p <- p + plot_markers(cal = acc(), markers = 'markers')
  if (input$today) p <- p + today_marker()
  return(p)
})
```

### Calendar


Configuration
=============

Configuration {data-height=900}
--------------------------------

```{r show configuration}
cfg_txt <- reactive({
  req(cfg_file)
  d <- paste(readLines(con = cfg_file), collapse = '\n')
  return(d)
})
cfg <- reactive({
  req(cfg_file)
  read_config(cfg_file)
})
textAreaInput('config', label = NULL, width = '100%', rows = 20,
              placeholder = 'Enter or load configuration YAML')
observeEvent(input$load_default, {
  cfg_file <- pkgload::package_file('inst/default_config.yml')
  updateTextAreaInput(session, 'config', value = cfg_txt())
})
```

Buttons {data-height=100}
-------------------------

```{r upload file}
fluidRow(
  ## column(width = 12,
  ##        splitLayout(cellWidths = c('30%', '20%', '20%', '10%'),
  ##                    fileInput('cfg_upload', label = NULL, accept = c('yml', 'yaml')),
  ##                    actionButton('load_default', 'Load package default configuration'),
  ##                    actionButton('export', 'Export config to disk')
  ##                    )
  ##        )
  column(width = 5,
         fileInput('cfg_upload', label = NULL, accept = c('yml', 'yaml'))),
  column(width = 5,
         actionButton('load_default', 'Load default configuration')),
 )
fluidRow(
  column(width = 5,
         actionButton('activate', 'Use new values')),
  column(width = 5,
         actionButton('export', 'Export config to disk'))
)
observeEvent(input$cfg_upload, {
  cfg_raw <- paste(readLines(input$cfg_upload$datapath), collapse = '\n')
  updateTextAreaInput(session, 'config', value = cfg_raw)
})
```
